name: "Setup PHP and Mysql"

inputs:
  php_version:
    description: "The PHP version to run"
    default: '7.4'
    required: false
  mysql_version:
    description: "The MySQL version to run"
    default: '5.7'
    required: false
  db_name:
    description: "The DB name. Default is [test]"
    required: false
    default: 'test'
  db_username:
    description: "The DB username. Default is [user]"
    required: false
    default: 'user'
  db_password:
    required: false
    default: 'password'
    description: "The DB password. Default is [password]"
  db_port:
    description: "The DB port. Default is [3306]"
    required: false
    default: '3306'

runs:
  using: "composite"
  steps:

    - name: Setup PHP, with composer and extensions
      uses: shivammathur/setup-php@v2 #https://github.com/shivammathur/setup-php
      with:
        php-version: ${{ inputs.php_version }}
        extensions: mbstring, dom, fileinfo, mysql
        coverage: xdebug #optional

    - name: Get composer cache directory
      id: composer-cache
      run: echo "::set-output name=dir::$(composer config cache-files-dir)"
      shell: bash

    - name: Cache composer dependencies
      uses: actions/cache@v2
      with:
        path: ${{ steps.composer-cache.outputs.dir }}
        key: ${{ runner.os }}-PHP${{ inputs.php_version }}-composer-${{ hashFiles('**/composer.lock') }}
        restore-keys: ${{ runner.os }}-PHP${{ inputs.php_version }}-composer-

    - name: Install Composer dependencies
      run: composer install --no-progress --prefer-dist --optimize-autoloader
      shell: bash

    - name: Shutdown Ubuntu MySQL (SUDO)
      run: sudo service mysql stop
      shell: bash

    - name: "Setup MySQL"
      uses: mirromutth/mysql-action@v1.1
      with:
        host port: ${{ inputs.db_port }}
        container port: ${{ inputs.db_port }}
        character set server: 'utf8'
        collation server: 'utf8_general_ci'
        mysql version: ${{ inputs.mysql_version }}
        mysql database: ${{ inputs.db_name }}
        mysql root password: ${{ inputs.db_password }}
        mysql user: ${{ inputs.db_username }}
        mysql password: ${{ inputs.db_password }}

    - name: Wait for MySQL
      run: |
        while ! mysqladmin ping --host=127.0.0.1 --password=${{ inputs.db_password }} --user=${{ inputs.db_username }} --port=${{ inputs.db_port }} --silent; do
          sleep 1
        done
      shell: bash
      
    - name: Echo PHP and MySQL version for debug purposes
      run: |
        echo '-------- [MySQL] --------'
        mysqld --version
        echo '--------- [PHP] ---------'
        php -v
        echo '-------------------------'
      shell: bash

