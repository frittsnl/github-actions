name: "Setup PHP and Mysql"

inputs:
  phpVersion:
    description: "The PHP version to run"
    default: '7.4'
    required: false
  mysqlVersion:
    description: "The MySQL version to run"
    default: '5.7'
    required: false
  dbName:
    description: "The DB name. Default is [test_db]"
    required: false
    default: 'test_db'
  dbUsername:
    description: "The DB username. Default is [test_user]"
    required: false
    default: 'test_user'
  dbPassword:
    required: false
    default: 'test_password'
    description: "The DB password. Default is [test_password]"
  dbPort:
    description: "The DB port. Default is [3306]"
    required: false
    default: '3306'
  sdGithubAccessToken:
    description: 'Access token to set before running composer.'
    default: 'false' #a bit hacky
    required: false
  extensions:
    description: 'Setup PHP extensions.'
    required: false
  iniValues:
    description: 'Add values to php.ini.'
    required: false
  coverage:
    description: 'Setup code coverage driver.'
    required: false
  tools:
    description: 'Setup popular tools globally.'
    required: false
  composerInstallOptions:
    required: false
    default: '--no-progress --prefer-dist --optimize-autoloader'
    description: "Custom composer install options"

runs:
  using: "composite"
  steps:

    - name: Test defaults
      run: echo ${{ inputs.dbUsername }}
      shell: bash

    - name: Shutdown Ubuntu MySQL (SUDO)
      run: sudo service mysql stop
      shell: bash

    - name: "Setup MySQL"
      uses: mirromutth/mysql-action@v1.1
      with:
        host port: ${{ inputs.dbPort }}
        container port: ${{ inputs.dbPort }}
        character set server: 'utf8'
        collation server: 'utf8_general_ci'
        mysql version: ${{ inputs.mysqlVersion }}
        mysql database: ${{ inputs.dbName }}
        mysql user: ${{ inputs.dbUsername }}
        mysql password: ${{ inputs.dbPassword }}

    - name: Setup PHP, with composer and extensions
      uses: shivammathur/setup-php@v2 #https://github.com/shivammathur/setup-php
      with:
        php-version: ${{ inputs.phpVersion }}
        extensions: ${{ inputs.php_extensions }}
        iniValues: ${{ inputs.php_iniValues }}
        coverage: ${{ inputs.php_coverage }}
        tools: ${{ inputs.php_tools }}

    - name: Get composer cache directory
      id: composer-cache
      run: echo "::set-output name=dir::$(composer config cache-files-dir)"
      shell: bash

    - name: Cache composer dependencies
      uses: actions/cache@v2
      with:
        path: ${{ steps.composer-cache.outputs.dir }}
        key: ${{ runner.os }}-PHP${{ inputs.phpVersion }}-composer-${{ hashFiles('**/composer.lock') }}
        restore-keys: ${{ runner.os }}-PHP${{ inputs.phpVersion }}-composer-

### If not supported (yet) https://github.com/actions/runner/issues/834
    - name: Link github token to composer; allows accesing sundata-package on github
      run: |
        if echo ${{ inputs.sdGithubAccessToken }} | grep -c "false"
        then
          echo "No key to set for composer"
        else
          composer config -g github-oauth.github.com ${{ inputs.sdGithubAccessToken }}
        fi
      shell: bash

    - name: Install Composer dependencies
      run: composer install ${{ inputs.composerInstallOptions }}
      shell: bash

    - name: Wait for MySQL
      run: |
        while ! mysqladmin ping --host=127.0.0.1 --password=${{ inputs.dbPassword }} --user=${{ inputs.dbUsername }} --port=${{ inputs.dbPort }} --silent
        do
            echo "Waiting for MySQL..."
            ((count++)) && ((count==30)) && break
            sleep 1
        done
      shell: bash

    - name: Debug MySQL version
      run: mysql --host=127.0.0.1 -u ${{ inputs.dbUsername }} -p${{ inputs.dbPassword }} --port=${{ inputs.dbPort }} -e "SHOW VARIABLES LIKE \"%version%\";"
      shell: bash

    - name: Debug PHP version
      run: php -v
      shell: bash
