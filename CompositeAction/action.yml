name: "Setup PHP and Mysql"

inputs:
  php_version:
    description: "The PHP version to run"
    required: true
  mysql_version:
    description: "The MySQL version to run"
    required: true

runs:
  using: "composite"
  services:
    mysql:
      image: mysql:${{ inputs.mysql_version }}
      env:
        MYSQL_DATABASE: test_db
        MYSQL_ROOT_PASSWORD: password
      ports:
        - 3306/tcp
      options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3
  steps:
    - name: Setup PHP, with composer and extensions
    uses: shivammathur/setup-php@v2 #https://github.com/shivammathur/setup-php
    with:
      php-version: ${{ inputs.php_version }}
      extensions: mbstring, dom, fileinfo, mysql
      coverage: xdebug #optional
  - name: Start mysql service
    run: sudo /etc/init.d/mysql start
  - name: Get composer cache directory
    id: composer-cache
    run: echo "::set-output name=dir::$(composer config cache-files-dir)"
  - name: Cache composer dependencies
    uses: actions/cache@v2
    with:
      path: ${{ steps.composer-cache.outputs.dir }}
      key: ${{ runner.os }}-PHP${{ inputs.php_version }}-composer-${{ hashFiles('**/composer.lock') }}
      restore-keys: ${{ runner.os }}-composer-
  - name: Install Composer dependencies
    run: composer install --no-progress --prefer-dist --optimize-autoloader
